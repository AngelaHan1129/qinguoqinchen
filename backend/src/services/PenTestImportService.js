// src/services/PenTestImportService.js
const Logger = require('../utils/logger');

class PenTestImportService {
    constructor(ragService) {
        this.ragService = ragService;
        Logger.info('âœ… æ»²é€æ¸¬è©¦åŒ¯å…¥æœå‹™åˆå§‹åŒ–å®Œæˆ');
    }

    async importPenTestReport(reportData, metadata) {
        Logger.info('ğŸ“Š è™•ç†æ»²é€æ¸¬è©¦å ±å‘Š...');

        // æ¨¡æ“¬è™•ç†æ»²é€æ¸¬è©¦å ±å‘Š
        const mockFindings = [
            {
                title: 'é«˜é¢¨éšª SQL æ³¨å…¥æ¼æ´ - eKYC ç™»å…¥é é¢',
                content: `åœ¨ eKYC èº«åˆ†é©—è­‰ç³»çµ±çš„ç™»å…¥é é¢ç™¼ç¾åš´é‡çš„ SQL æ³¨å…¥æ¼æ´ã€‚

æŠ€è¡“è©³æƒ…ï¼š
- æ¼æ´ä½ç½®: /api/auth/login
- åƒæ•¸: username, password
- æ”»æ“Šå‘é‡: ' OR '1'='1' --
- è³‡æ–™åº«é¡å‹: PostgreSQL

å½±éŸ¿åˆ†æï¼š
- å¯èƒ½å°è‡´æ•´å€‹ç”¨æˆ¶è³‡æ–™åº«æ´©éœ²
- æ”»æ“Šè€…å¯ç²å–å€‹äººèº«åˆ†è³‡è¨Š
- é•åå€‹äººè³‡æ–™ä¿è­·æ³•ç¬¬6æ¢è¦å®š
- å¯èƒ½é¢è‡¨æ³•å¾‹è²¬ä»»å’Œç›£ç®¡è™•ç½°

ä¿®å¾©å»ºè­°ï¼š
1. ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢ (Parameterized Queries)
2. å¯¦æ–½è¼¸å…¥é©—è­‰å’Œæ¸…ç†
3. æ¡ç”¨æœ€å°æ¬Šé™åŸå‰‡
4. å•Ÿç”¨è³‡æ–™åº«æ´»å‹•ç›£æ§`,
                documentType: 'pentest_finding',
                jurisdiction: 'TECHNICAL',
                lawCategory: 'æ»²é€æ¸¬è©¦',
                articleNumber: 'PENTEST-001',
                source: 'pentest_import'
            },
            {
                title: 'ä¸­é¢¨éšª XSS æ¼æ´ - èº«åˆ†é©—è­‰çµæœé é¢',
                content: `ç™¼ç¾è·¨ç«™è…³æœ¬æ”»æ“Š (XSS) æ¼æ´ï¼Œå¯èƒ½è¢«åˆ©ç”¨ç«Šå–ç”¨æˆ¶ sessionã€‚

æŠ€è¡“è©³æƒ…ï¼š
- æ¼æ´ä½ç½®: /kyc/result
- æ¼æ´é¡å‹: Reflected XSS
- è§¸ç™¼åƒæ•¸: message
- åˆ©ç”¨æ–¹å¼: <script>alert('XSS')</script>

é¢¨éšªè©•ä¼°ï¼š
- å¯èƒ½ç«Šå–ç”¨æˆ¶ session token
- åŸ·è¡Œæƒ¡æ„è…³æœ¬
- å½±éŸ¿ç”¨æˆ¶é«”é©—å’Œä¿¡ä»»

ä¿®å¾©å»ºè­°ï¼š
1. å¯¦æ–½ Content Security Policy (CSP)
2. è¼¸å‡ºç·¨ç¢¼è™•ç†
3. ä½¿ç”¨ Web Application Firewall (WAF)`,
                documentType: 'pentest_finding',
                jurisdiction: 'TECHNICAL',
                lawCategory: 'æ»²é€æ¸¬è©¦',
                articleNumber: 'PENTEST-002',
                source: 'pentest_import'
            }
        ];

        const results = [];
        for (const finding of mockFindings) {
            try {
                const result = await this.ragService.ingestLegalDocument({
                    ...finding,
                    metadata: {
                        ...metadata,
                        severity: finding.title.includes('é«˜é¢¨éšª') ? 'high' : 'medium',
                        category: finding.title.includes('SQL') ? 'injection' : 'xss',
                        testDate: new Date().toISOString(),
                        complianceImpact: {
                            pdpa: finding.content.includes('å€‹äººè³‡æ–™ä¿è­·æ³•'),
                            iso27001: true,
                            owasp: true
                        }
                    }
                });
                results.push(result);
                Logger.info(`âœ… åŒ¯å…¥æ»²é€æ¸¬è©¦ç™¼ç¾: ${finding.title}`);
            } catch (error) {
                Logger.error(`âŒ åŒ¯å…¥å¤±æ•—: ${finding.title}`, error.message);
            }
        }

        return results;
    }

    async importForensicsEvidence(evidenceData, metadata) {
        Logger.info('ğŸ” è™•ç†æ•¸ä½å–è­‰è­‰æ“š...');

        // æ¨¡æ“¬è™•ç†å–è­‰è­‰æ“š
        const mockEvidence = [
            {
                title: 'ç£ç¢Ÿæ˜ åƒæª”åˆ†æ - å¯ç–‘æª”æ¡ˆç™¼ç¾',
                content: `å¾ä¼ºæœå™¨ç£ç¢Ÿæ˜ åƒæª”ä¸­ç™¼ç¾å¯ç–‘çš„æƒ¡æ„è»Ÿé«”å’Œæœªæˆæ¬Šå­˜å–è¨˜éŒ„ã€‚

ç™¼ç¾é …ç›®ï¼š
1. æƒ¡æ„è»Ÿé«”æ¨£æœ¬: trojan.exe (MD5: d41d8cd98f00b204e9800998ecf8427e)
2. æœªæˆæ¬Š SSH é€£ç·šè¨˜éŒ„
3. ç•°å¸¸çš„è³‡æ–™åº«æŸ¥è©¢æ—¥èªŒ
4. å€‹äººè³‡æ–™å¤–æ´©ç—•è·¡

æ³•å¾‹æ„æ¶µï¼š
- å¯èƒ½æ§‹æˆåˆ‘æ³•å¦¨å®³é›»è…¦ä½¿ç”¨ç½ª
- é•åå€‹äººè³‡æ–™ä¿è­·æ³•
- éœ€è¦ä¿å…¨è­‰æ“šéˆå®Œæ•´æ€§`,
                documentType: 'forensics_evidence',
                jurisdiction: 'TECHNICAL',
                lawCategory: 'æ•¸ä½å–è­‰',
                articleNumber: 'FORENSICS-001',
                source: 'forensics_import'
            }
        ];

        const results = [];
        for (const evidence of mockEvidence) {
            try {
                const result = await this.ragService.ingestLegalDocument({
                    ...evidence,
                    metadata: {
                        ...metadata,
                        evidenceType: 'disk_analysis',
                        chainOfCustody: true,
                        legalAdmissibility: 'high',
                        analysisDate: new Date().toISOString()
                    }
                });
                results.push(result);
                Logger.info(`âœ… åŒ¯å…¥å–è­‰è­‰æ“š: ${evidence.title}`);
            } catch (error) {
                Logger.error(`âŒ åŒ¯å…¥å¤±æ•—: ${evidence.title}`, error.message);
            }
        }

        return results;
    }
}

module.exports = PenTestImportService;
