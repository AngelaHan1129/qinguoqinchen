// composables/pentest.ts
import { onMounted, onUnmounted, ref, computed } from 'vue'
import { usePentestUI } from '@/composables/dashboard'
import type { AttackModVector } from '@/composables/getapi'

// å®šç¾©å®Œæ•´æ¸¬è©¦å›æ‡‰é¡å‹
interface FullPentestResponse {
    success: boolean
    sessionId: string
    executiveSummary: {
        totalVectors: number
        successfulAttacks: number
        failedAttacks: number
        overallSuccessRate: string
        riskLevel: string
        testDuration: string
        timestamp: string
    }
    attackResults: {
        vectors: any[]
        summary: any
        metrics: any
    }
    grokReports: {
        pentestReport: {
            content: string
            model: string
        }
        attackRecommendations: {
            content: string
            model: string
        }
    }
    downloads: {
        pdfReport: string | null
        excelReport: string | null
    }
    metadata: any
}

// âœ… æ–°å¢:åŸ·è¡Œå®Œæ•´æ»²é€æ¸¬è©¦
async function executeFullPentestAPI(config: {
    vectorIds: string[]
    intensity: 'low' | 'medium' | 'high'
    targetUrl: string
    generateReports: boolean
}): Promise<FullPentestResponse> {
    const response = await fetch(`${process.env.NUXT_PUBLIC_API_BASE_URL}/pentest/execute/full`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })

    if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }

    return await response.json()
}

// ä¸»è¦çš„ pentest composable
export function usePentestMain() {
    const { urlInput, selectedFileName } = usePentestUI()

    const attackMods = ref<(AttackModVector & { selected: boolean })[]>([])
    const attackIntensity = ref<'low' | 'medium' | 'high'>('high')
    const isExecuting = ref(false)
    const logs = ref<Array<{ timestamp: string; level: string; message: string }>>([])
    const pentestResult = ref<FullPentestResponse | null>(null)

    // âœ… ä¿®æ­£:è™•ç†æ”»æ“Šæ¨¡çµ„é€å‡º - ä½¿ç”¨æ–° API
    async function handleSubmitAttackMods() {
        const selectedMods = attackMods.value.filter(mod => mod.selected)

        if (selectedMods.length === 0) {
            addLogEntry('warning', 'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ AI æ”»æ“Šæ¨¡çµ„')
            return
        }

        if (isExecuting.value) {
            addLogEntry('warning', 'æ”»æ“Šæ¸¬è©¦æ­£åœ¨åŸ·è¡Œä¸­ï¼Œè«‹ç¨å€™...')
            return
        }

        isExecuting.value = true

        // è¨˜éŒ„é¸ä¸­çš„æ¨¡çµ„
        addLogEntry('info', `å·²é¸æ“‡ ${selectedMods.length} å€‹ AI æ”»æ“Šæ¨¡çµ„`)
        selectedMods.forEach(mod => {
            addLogEntry('info', `- ${mod.model} (é›£åº¦: ${mod.difficulty})`)
        })

        // é–‹å§‹æ”»æ“Šæ¸¬è©¦
        addLogEntry('success', `é–‹å§‹åŸ·è¡Œå®Œæ•´æ»²é€æ¸¬è©¦ (å¼·åº¦: ${attackIntensity.value.toUpperCase()})...`)

        try {
            // âœ… å‘¼å«å®Œæ•´æ»²é€æ¸¬è©¦ API
            const config = {
                vectorIds: selectedMods.map(mod => mod.id),
                intensity: attackIntensity.value,
                targetUrl: urlInput.value || 'https://bank-ekyc.example.com',
                generateReports: true
            }

            addLogEntry('info', 'æ­£åœ¨åŸ·è¡Œå®Œæ•´æ»²é€æ¸¬è©¦æµç¨‹...')
            addLogEntry('info', 'éšæ®µ 1/8: åŸ·è¡Œæ”»æ“Šæ¸¬è©¦...')

            const result = await executeFullPentestAPI(config)
            pentestResult.value = result

            if (result.success) {
                addLogEntry('success', `âœ… æ»²é€æ¸¬è©¦å®Œæˆï¼Session ID: ${result.sessionId}`)

                // è¨˜éŒ„åŸ·è¡Œæ‘˜è¦
                const summary = result.executiveSummary
                addLogEntry('info', `ç¸½æ”»æ“Šå‘é‡: ${summary.totalVectors}`)
                addLogEntry('info', `æˆåŠŸæ”»æ“Šæ•¸: ${summary.successfulAttacks}`)
                addLogEntry('info', `å¤±æ•—æ”»æ“Šæ•¸: ${summary.failedAttacks}`)
                addLogEntry('info', `æˆåŠŸç‡: ${summary.overallSuccessRate}`)
                addLogEntry('warning', `é¢¨éšªç­‰ç´š: ${summary.riskLevel}`)
                addLogEntry('info', `åŸ·è¡Œæ™‚é–“: ${summary.testDuration}`)

                // è¨˜éŒ„å ±å‘Šç”Ÿæˆç‹€æ…‹
                if (result.downloads.pdfReport) {
                    addLogEntry('success', `ğŸ“„ PDF å ±å‘Šå·²ç”Ÿæˆ: ${result.downloads.pdfReport}`)
                }
                if (result.downloads.excelReport) {
                    addLogEntry('success', `ğŸ“Š Excel å ±å‘Šå·²ç”Ÿæˆ: ${result.downloads.excelReport}`)
                }

                // å„²å­˜çµæœåˆ° localStorage
                localStorage.setItem('pentestResult', JSON.stringify(result))

                // âœ… 3ç§’å¾Œè‡ªå‹•è·³è½‰åˆ°å ±å‘Šé é¢
                addLogEntry('success', 'âœ¨ 3ç§’å¾Œå°‡è‡ªå‹•è·³è½‰åˆ°å ±å‘Šé é¢...')
                setTimeout(() => {
                    navigateTo({
                        path: '/reports',
                        query: { sessionId: result.sessionId }
                    })
                }, 3000)

            } else {
                addLogEntry('error', 'âŒ æ»²é€æ¸¬è©¦åŸ·è¡Œå¤±æ•—')
            }

        } catch (error) {
            addLogEntry('error', `âŒ æ”»æ“Šæ¸¬è©¦å•Ÿå‹•å¤±æ•—: ${error}`)
            console.error('æ”»æ“ŠåŸ·è¡ŒéŒ¯èª¤:', error)
        } finally {
            isExecuting.value = false
        }
    }

    function addLogEntry(level: string, message: string) {
        const entry = {
            timestamp: new Date().toLocaleTimeString('zh-TW'),
            level,
            message
        }
        logs.value.push(entry)

        // æ›´æ–° DOM
        const logContainer = document.getElementById('logContainer')
        if (logContainer) {
            const logElement = document.createElement('div')
            logElement.className = `log-entry log-${level}`
            logElement.textContent = `[${entry.timestamp}] ${level.toUpperCase()} - ${entry.message}`
            logContainer.appendChild(logElement)
            logContainer.scrollTop = logContainer.scrollHeight
        }
    }

    function clearLogs() {
        logs.value = []
        const logContainer = document.getElementById('logContainer')
        if (logContainer) {
            logContainer.innerHTML = ''
        }
        addLogEntry('info', 'æ—¥èªŒå·²æ¸…ç©º')
    }

    const selectedModsCount = computed(() =>
        attackMods.value.filter(mod => mod.selected).length
    )

    const hasSelectedMods = computed(() => selectedModsCount.value > 0)

    return {
        urlInput,
        selectedFileName,
        attackMods,
        selectedModsCount,
        hasSelectedMods,
        attackIntensity,
        isExecuting,
        handleSubmitAttackMods,
        clearLogs,
        logs,
        pentestResult
    }
}
