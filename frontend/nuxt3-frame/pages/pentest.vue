<!-- pages/pentest.vue -->
<template>
  <div class="terminal-container">
    <!-- Terminal 視窗 -->
    <div class="terminal-window">
      <div class="terminal-header">
        <div class="header-left">
          <span class="terminal-title">🔥 侵國侵城 AI 滲透測試系統</span>
        </div>
        <div class="header-right">
          <span class="status-badge" :class="isExecuting ? 'status-running' : 'status-idle'">
            {{ isExecuting ? '🚀 執行中' : '⚡ 就緒' }}
          </span>
        </div>
      </div>

      <div class="terminal-body">
        <!-- 配置區 -->
        <section class="config-section" v-if="!isExecuting">
          <h2 class="section-title">⚙️ 測試配置</h2>
          
          <form @submit.prevent="executePentest" class="config-form">
            <!-- 目標 URL -->
            <div class="form-group">
              <label class="form-label">🎯 目標 URL</label>
              <input 
                v-model="testConfig.targetUrl" 
                type="text" 
                required 
                class="form-input"
                placeholder="https://bank-ekyc.example.com"
              >
            </div>

            <!-- 攻擊向量選擇 -->
            <div class="form-group">
              <label class="form-label">🤖 AI 攻擊模組 ({{ selectedVectorsCount }} / {{ availableVectors.length }})</label>
              <div class="vector-grid">
                <label 
                  v-for="vector in availableVectors" 
                  :key="vector"
                  class="vector-card"
                  :class="{ 'vector-selected': testConfig.vectorIds.includes(vector) }"
                >
                  <input 
                    type="checkbox" 
                    :value="vector" 
                    v-model="testConfig.vectorIds"
                    class="vector-checkbox"
                  >
                  <div class="vector-content">
                    <span class="vector-id">{{ vector }}</span>
                    <span class="vector-name">{{ vectorNames[vector] }}</span>
                  </div>
                </label>
              </div>
            </div>

            <!-- 測試強度 -->
            <div class="form-group">
              <label class="form-label">⚡ 測試強度</label>
              <div class="intensity-selector">
                <label 
                  v-for="level in intensityLevels" 
                  :key="level.value"
                  class="intensity-option"
                  :class="{ 'intensity-selected': testConfig.intensity === level.value }"
                >
                  <input 
                    type="radio" 
                    :value="level.value" 
                    v-model="testConfig.intensity"
                    class="intensity-radio"
                  >
                  <span class="intensity-label">{{ level.icon }} {{ level.label }}</span>
                </label>
              </div>
            </div>

            <!-- 報告生成選項 -->
            <div class="form-group">
              <label class="checkbox-wrapper">
                <input 
                  type="checkbox" 
                  v-model="testConfig.generateReports"
                  class="report-checkbox"
                >
                <span class="checkbox-label">📄 生成 PDF/Excel 合規報告</span>
              </label>
            </div>

            <!-- 提交按鈕 -->
            <button 
              type="submit" 
              class="submit-attack-btn"
              :disabled="!hasSelectedVectors || isExecuting"
            >
              <span class="btn-icon">🚀</span>
              <span>啟動滲透測試</span>
              <span v-if="hasSelectedVectors" class="btn-count">{{ selectedVectorsCount }}</span>
            </button>
          </form>
        </section>

        <!-- 執行進度區 -->
        <section v-if="isExecuting" class="progress-section">
          <h2 class="section-title">📊 執行進度</h2>
          
          <div class="test-progress">
            <div 
              v-for="(step, index) in executionSteps" 
              :key="index"
              class="test-step"
              :class="{ 
                'active': step.status === 'running',
                'completed': step.status === 'completed'
              }"
            >
              <div 
                class="step-icon" 
                :class="{ 
                  'running': step.status === 'running',
                  'completed': step.status === 'completed'
                }"
              >
                <span v-if="step.status === 'completed'">✓</span>
                <span v-else-if="step.status === 'running'">⟳</span>
                <span v-else>{{ index + 1 }}</span>
              </div>
              <div class="step-content">
                <div class="step-title">{{ step.title }}</div>
                <div class="step-description">{{ step.description }}</div>
              </div>
            </div>
          </div>

          <!-- 進度條 -->
          <div class="progress-bar-container">
            <div class="progress-bar">
              <div 
                class="progress-fill" 
                :style="{ width: executionProgress + '%' }"
              ></div>
            </div>
            <div class="progress-text">{{ executionProgress }}% 完成</div>
          </div>
        </section>

        <!-- 實時日誌 -->
        <section v-if="logs.length > 0" class="log-section">
          <div class="log-header">
            <h2 class="section-title">📜 實時日誌</h2>
            <button @click="clearLogs" class="clear-logs-btn">清空</button>
          </div>
          <div id="logContainer" class="log-container">
            <div 
              v-for="(log, index) in logs" 
              :key="index"
              class="log-entry"
              :class="`log-${log.level}`"
            >
              [{{ log.timestamp }}] {{ log.level.toUpperCase() }} - {{ log.message }}
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- 快速測試場景 -->
    <div class="terminal-window" v-if="!isExecuting">
      <div class="terminal-header">
        <span class="terminal-title">⚡ 快速測試場景</span>
      </div>
      <div class="terminal-body">
        <div class="quick-scenario-grid">
          <button @click="loadBankScenario" class="scenario-card">
            <div class="scenario-icon">🏦</div>
            <div class="scenario-title">銀行 eKYC</div>
            <div class="scenario-desc">完整測試 (5 模組)</div>
          </button>
          <button @click="loadInsuranceScenario" class="scenario-card">
            <div class="scenario-icon">🛡️</div>
            <div class="scenario-title">保險 eKYC</div>
            <div class="scenario-desc">部分測試 (2 模組)</div>
          </button>
          <button @click="loadFintechScenario" class="scenario-card">
            <div class="scenario-icon">💰</div>
            <div class="scenario-title">金融科技 eKYC</div>
            <div class="scenario-desc">中等強度 (3 模組)</div>
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useRuntimeConfig } from '#app'

const router = useRouter()
const config = useRuntimeConfig()

// ✅ 使用環境變數
const apiBaseUrl = config.public.apiBaseUrl || 'http://localhost:7939'

// 測試配置
const testConfig = ref({
  vectorIds: ['A1', 'A2', 'A3', 'A4', 'A5'],
  intensity: 'medium',
  targetUrl: 'https://bank-ekyc.example.com',
  generateReports: true
})

const availableVectors = ['A1', 'A2', 'A3', 'A4', 'A5']
const vectorNames: Record<string, string> = {
  'A1': 'StyleGAN3',
  'A2': 'Stable Diffusion',
  'A3': 'SimSwap',
  'A4': 'DeepFaceLab',
  'A5': 'DALL·E'
}

const intensityLevels = [
  { value: 'low', label: '低', icon: '🟢' },
  { value: 'medium', label: '中', icon: '🟡' },
  { value: 'high', label: '高', icon: '🔴' }
]

// 執行狀態
const isExecuting = ref(false)
const executionProgress = ref(0)
const logs = ref<Array<{ timestamp: string; level: string; message: string }>>([])

// 執行步驟
const executionSteps = ref([
  { title: '階段 1: 執行攻擊測試', description: '正在初始化 AI 攻擊模組...', status: 'pending' },
  { title: '階段 2: OWASP ZAP 掃描', description: '執行 Web 應用程式安全掃描...', status: 'pending' },
  { title: '階段 3: Grok AI 分析', description: '生成滲透測試報告...', status: 'pending' },
  { title: '階段 4: Grok AI 紅隊建議', description: '生成攻擊建議...', status: 'pending' },
  { title: '階段 5: RAG 知識檢索', description: '檢索安全知識庫...', status: 'pending' },
  { title: '階段 6: Gemini 企業建議', description: '生成企業改善建議...', status: 'pending' },
  { title: '階段 7: Gemini 防禦策略', description: '生成防禦策略...', status: 'pending' },
  { title: '階段 8: 生成報告', description: '生成 PDF/Excel 報告...', status: 'pending' }
])

// 計算屬性
const selectedVectorsCount = computed(() => testConfig.value.vectorIds.length)
const hasSelectedVectors = computed(() => selectedVectorsCount.value > 0)

// 方法
async function executePentest() {
  if (!hasSelectedVectors.value) {
    addLog('warning', '請至少選擇一個 AI 攻擊模組')
    return
  }

  isExecuting.value = true
  executionProgress.value = 0
  logs.value = []
  
  // 重置步驟狀態
  executionSteps.value.forEach(step => step.status = 'pending')

  addLog('info', '🚀 開始執行完整滲透測試...')
  addLog('info', `目標: ${testConfig.value.targetUrl}`)
  addLog('info', `強度: ${testConfig.value.intensity.toUpperCase()}`)
  addLog('info', `模組: ${testConfig.value.vectorIds.join(', ')}`)

  try {
    // 模擬進度更新
    const progressInterval = setInterval(() => {
      if (executionProgress.value < 90) {
        executionProgress.value += 11.25 // 8個階段,每階段 11.25%
        const currentStep = Math.floor(executionProgress.value / 12.5)
        if (currentStep < executionSteps.value.length) {
          if (currentStep > 0) {
            executionSteps.value[currentStep - 1].status = 'completed'
          }
          executionSteps.value[currentStep].status = 'running'
        }
      }
    }, 6000) // 每6秒一個階段

    // ✅ 呼叫後端 API (使用環境變數)
    const response = await fetch(`${apiBaseUrl}/pentest/execute/full`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(testConfig.value)
    })

    clearInterval(progressInterval)
    executionProgress.value = 100

    // 標記所有步驟完成
    executionSteps.value.forEach(step => step.status = 'completed')

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }

    const result = await response.json()

    addLog('success', `✅ 滲透測試完成！Session ID: ${result.sessionId}`)
    addLog('info', `成功率: ${result.executiveSummary.overallSuccessRate}`)
    addLog('warning', `風險等級: ${result.executiveSummary.riskLevel}`)

    if (result.downloads.pdfReport) {
      addLog('success', `📄 PDF 報告: ${result.downloads.pdfReport}`)
    }

    // 儲存結果
    localStorage.setItem('pentestResult', JSON.stringify(result))

    // 3秒後跳轉
    addLog('success', '✨ 3秒後跳轉到報告頁面...')
    setTimeout(() => {
      router.push({
        path: '/reports',
        query: { sessionId: result.sessionId }
      })
    }, 3000)

  } catch (error: any) {
    addLog('error', `❌ 測試失敗: ${error.message}`)
    console.error('執行錯誤:', error)
  } finally {
    setTimeout(() => {
      isExecuting.value = false
    }, 3500)
  }
}

function addLog(level: string, message: string) {
  const timestamp = new Date().toLocaleTimeString('zh-TW')
  logs.value.push({ timestamp, level, message })
}

function clearLogs() {
  logs.value = []
  addLog('info', '日誌已清空')
}

// 快速場景
function loadBankScenario() {
  testConfig.value = {
    vectorIds: ['A1', 'A2', 'A3', 'A4', 'A5'],
    intensity: 'high',
    targetUrl: 'https://bank-ekyc.example.com',
    generateReports: true
  }
  addLog('info', '✅ 已載入銀行 eKYC 測試場景')
}

function loadInsuranceScenario() {
  testConfig.value = {
    vectorIds: ['A3', 'A5'],
    intensity: 'high',
    targetUrl: 'https://insurance-ekyc.example.com',
    generateReports: true
  }
  addLog('info', '✅ 已載入保險 eKYC 測試場景')
}

function loadFintechScenario() {
  testConfig.value = {
    vectorIds: ['A1', 'A3', 'A5'],
    intensity: 'medium',
    targetUrl: 'https://fintech-ekyc.example.com',
    generateReports: false
  }
  addLog('info', '✅ 已載入金融科技 eKYC 測試場景')
}
</script>

<style scoped>
@import '@/assets/css/pentest.css';

/* 額外樣式 */
.config-form {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-label {
  color: var(--neon-green);
  font-weight: 600;
  font-size: 1rem;
}

.form-input {
  background: rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(57, 255, 20, 0.3);
  border-radius: 8px;
  padding: 0.75rem 1rem;
  color: var(--text-primary);
  font-size: 1rem;
  transition: all 0.3s;
}

.form-input:focus {
  outline: none;
  border-color: var(--neon-green);
  box-shadow: 0 0 15px rgba(57, 255, 20, 0.3);
}

/* 向量卡片網格 */
.vector-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
}

.vector-card {
  background: rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(57, 255, 20, 0.3);
  border-radius: 10px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.vector-card:hover {
  border-color: var(--neon-cyan);
  transform: translateY(-2px);
}

.vector-card.vector-selected {
  border-color: var(--neon-green);
  background: rgba(57, 255, 20, 0.1);
}

.vector-checkbox {
  width: 18px;
  height: 18px;
}

.vector-content {
  display: flex;
  flex-direction: column;
}

.vector-id {
  color: var(--neon-green);
  font-weight: 700;
}

.vector-name {
  color: var(--text-secondary);
  font-size: 0.85rem;
}

/* 強度選擇器 */
.intensity-selector {
  display: flex;
  gap: 1rem;
}

.intensity-option {
  flex: 1;
  background: rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  padding: 0.75rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}

.intensity-option:hover {
  border-color: var(--neon-cyan);
}

.intensity-option.intensity-selected {
  border-color: var(--neon-green);
  background: rgba(57, 255, 20, 0.1);
}

.intensity-radio {
  display: none;
}

/* 快速場景 */
.quick-scenario-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.scenario-card {
  background: linear-gradient(135deg, rgba(10, 15, 28, 0.8), rgba(15, 25, 45, 0.6));
  border: 2px solid var(--neon-cyan);
  border-radius: 12px;
  padding: 1.5rem;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
}

.scenario-card:hover {
  border-color: var(--neon-green);
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(57, 255, 20, 0.3);
}

.scenario-icon {
  font-size: 3rem;
  margin-bottom: 0.5rem;
}

.scenario-title {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--neon-green);
  margin-bottom: 0.25rem;
}

.scenario-desc {
  color: var(--text-secondary);
  font-size: 0.9rem;
}
/* ✅ 修正日誌區域 header 樣式 */
.log-section {
  margin-top: 2rem;
}

.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  gap: 1rem; /* ✅ 加入間距 */
}

.section-title {
  color: var(--neon-green);
  font-size: 1.2rem;
  font-weight: 700;
  margin: 0; /* ✅ 移除預設 margin */
}

.clear-logs-btn {
  background: linear-gradient(135deg, rgba(255, 68, 68, 0.8), rgba(209, 112, 0, 0.6));
  border: 2px solid #FF4444;
  color: white;
  padding: 0.5rem 1.2rem;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  white-space: nowrap; /* ✅ 防止文字換行 */
}

.clear-logs-btn:hover {
  background: linear-gradient(135deg, rgba(255, 68, 68, 1), rgba(209, 112, 0, 0.8));
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 68, 68, 0.4);
}

.clear-logs-btn:active {
  transform: translateY(0);
}

/* 日誌容器樣式 */
.log-container {
  background: rgba(0, 0, 0, 0.8);
  border: 2px solid var(--neon-green);
  border-radius: 10px;
  padding: 1.5rem;
  font-family: 'Courier New', monospace;
  font-size: 0.9rem;
  height: 300px;
  overflow-y: auto;
  max-height: 400px;
}

/* 日誌條目動畫 */
.log-entry {
  margin: 0.5rem 0;
  opacity: 0;
  animation: log-appear 0.5s ease-in-out forwards;
  padding: 0.3rem 0;
  line-height: 1.4;
}

@keyframes log-appear {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* 日誌等級顏色 */
.log-success {
  color: var(--neon-green);
}

.log-warning {
  color: #FFD700;
}

.log-error {
  color: #FF4444;
}

.log-info {
  color: var(--neon-cyan);
}

/* 自訂滾動條 */
.log-container::-webkit-scrollbar {
  width: 8px;
}

.log-container::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.5);
  border-radius: 4px;
}

.log-container::-webkit-scrollbar-thumb {
  background: var(--neon-green);
  border-radius: 4px;
}

.log-container::-webkit-scrollbar-thumb:hover {
  background: var(--neon-cyan);
}

/* 響應式調整 */
@media (max-width: 768px) {
  .log-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .clear-logs-btn {
    width: 100%;
  }

  .log-container {
    height: 250px;
    font-size: 0.85rem;
  }
}

/* CSS 變數 (如果沒有在 pentest.css 中定義) */
:root {
  --neon-green: #39FF14;
  --neon-cyan: #00FFFF;
  --neon-pink: #FF10F0;
  --brand-orange: #D17000;
  --bg-dark: #000811;
  --bg-card: #0A0F1C;
  --text-primary: #FFFFFF;
  --text-secondary: rgba(255, 255, 255, 0.7);
}
</style>
