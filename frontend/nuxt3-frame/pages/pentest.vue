<!-- pages/pentest.vue -->
<template>
  <div class="terminal-container">
    <!-- Terminal è¦–çª— -->
    <div class="terminal-window">
      <div class="terminal-header">
        <div class="header-left">
          <span class="terminal-title">ğŸ”¥ ä¾µåœ‹ä¾µåŸ AI æ»²é€æ¸¬è©¦ç³»çµ±</span>
        </div>
        <div class="header-right">
          <span class="status-badge" :class="isExecuting ? 'status-running' : 'status-idle'">
            {{ isExecuting ? 'ğŸš€ åŸ·è¡Œä¸­' : 'âš¡ å°±ç·’' }}
          </span>
        </div>
      </div>

      <div class="terminal-body">
        <!-- é…ç½®å€ -->
        <section class="config-section" v-if="!isExecuting">
          <h2 class="section-title">âš™ï¸ æ¸¬è©¦é…ç½®</h2>
          
          <form @submit.prevent="executePentest" class="config-form">
            <!-- ç›®æ¨™ URL -->
            <div class="form-group">
              <label class="form-label">ğŸ¯ ç›®æ¨™ URL</label>
              <input 
                v-model="testConfig.targetUrl" 
                type="text" 
                required 
                class="form-input"
                placeholder="https://bank-ekyc.example.com"
              >
            </div>

            <!-- æ”»æ“Šå‘é‡é¸æ“‡ -->
            <div class="form-group">
              <label class="form-label">ğŸ¤– AI æ”»æ“Šæ¨¡çµ„ ({{ selectedVectorsCount }} / {{ availableVectors.length }})</label>
              <div class="vector-grid">
                <label 
                  v-for="vector in availableVectors" 
                  :key="vector"
                  class="vector-card"
                  :class="{ 'vector-selected': testConfig.vectorIds.includes(vector) }"
                >
                  <input 
                    type="checkbox" 
                    :value="vector" 
                    v-model="testConfig.vectorIds"
                    class="vector-checkbox"
                  >
                  <div class="vector-content">
                    <span class="vector-id">{{ vector }}</span>
                    <span class="vector-name">{{ vectorNames[vector] }}</span>
                  </div>
                </label>
              </div>
            </div>

            <!-- æ¸¬è©¦å¼·åº¦ -->
            <div class="form-group">
              <label class="form-label">âš¡ æ¸¬è©¦å¼·åº¦</label>
              <div class="intensity-selector">
                <label 
                  v-for="level in intensityLevels" 
                  :key="level.value"
                  class="intensity-option"
                  :class="{ 'intensity-selected': testConfig.intensity === level.value }"
                >
                  <input 
                    type="radio" 
                    :value="level.value" 
                    v-model="testConfig.intensity"
                    class="intensity-radio"
                  >
                  <span class="intensity-label">{{ level.icon }} {{ level.label }}</span>
                </label>
              </div>
            </div>

            <!-- å ±å‘Šç”Ÿæˆé¸é … -->
            <div class="form-group">
              <label class="checkbox-wrapper">
                <input 
                  type="checkbox" 
                  v-model="testConfig.generateReports"
                  class="report-checkbox"
                >
                <span class="checkbox-label">ğŸ“„ ç”Ÿæˆ PDF/Excel åˆè¦å ±å‘Š</span>
              </label>
            </div>

            <!-- æäº¤æŒ‰éˆ• -->
            <button 
              type="submit" 
              class="submit-attack-btn"
              :disabled="!hasSelectedVectors || isExecuting"
            >
              <span class="btn-icon">ğŸš€</span>
              <span>å•Ÿå‹•æ»²é€æ¸¬è©¦</span>
              <span v-if="hasSelectedVectors" class="btn-count">{{ selectedVectorsCount }}</span>
            </button>
          </form>
        </section>

        <!-- åŸ·è¡Œé€²åº¦å€ -->
        <section v-if="isExecuting" class="progress-section">
          <h2 class="section-title">ğŸ“Š åŸ·è¡Œé€²åº¦</h2>
          
          <div class="test-progress">
            <div 
              v-for="(step, index) in executionSteps" 
              :key="index"
              class="test-step"
              :class="{ 
                'active': step.status === 'running',
                'completed': step.status === 'completed'
              }"
            >
              <div 
                class="step-icon" 
                :class="{ 
                  'running': step.status === 'running',
                  'completed': step.status === 'completed'
                }"
              >
                <span v-if="step.status === 'completed'">âœ“</span>
                <span v-else-if="step.status === 'running'">âŸ³</span>
                <span v-else>{{ index + 1 }}</span>
              </div>
              <div class="step-content">
                <div class="step-title">{{ step.title }}</div>
                <div class="step-description">{{ step.description }}</div>
              </div>
            </div>
          </div>

          <!-- é€²åº¦æ¢ -->
          <div class="progress-bar-container">
            <div class="progress-bar">
              <div 
                class="progress-fill" 
                :style="{ width: executionProgress + '%' }"
              ></div>
            </div>
            <div class="progress-text">{{ executionProgress }}% å®Œæˆ</div>
          </div>
        </section>

        <!-- å¯¦æ™‚æ—¥èªŒ -->
        <section v-if="logs.length > 0" class="log-section">
          <div class="log-header">
            <h2 class="section-title">ğŸ“œ å¯¦æ™‚æ—¥èªŒ</h2>
            <button @click="clearLogs" class="clear-logs-btn">æ¸…ç©º</button>
          </div>
          <div id="logContainer" class="log-container">
            <div 
              v-for="(log, index) in logs" 
              :key="index"
              class="log-entry"
              :class="`log-${log.level}`"
            >
              [{{ log.timestamp }}] {{ log.level.toUpperCase() }} - {{ log.message }}
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- å¿«é€Ÿæ¸¬è©¦å ´æ™¯ -->
    <div class="terminal-window" v-if="!isExecuting">
      <div class="terminal-header">
        <span class="terminal-title">âš¡ å¿«é€Ÿæ¸¬è©¦å ´æ™¯</span>
      </div>
      <div class="terminal-body">
        <div class="quick-scenario-grid">
          <button @click="loadBankScenario" class="scenario-card">
            <div class="scenario-icon">ğŸ¦</div>
            <div class="scenario-title">éŠ€è¡Œ eKYC</div>
            <div class="scenario-desc">å®Œæ•´æ¸¬è©¦ (5 æ¨¡çµ„)</div>
          </button>
          <button @click="loadInsuranceScenario" class="scenario-card">
            <div class="scenario-icon">ğŸ›¡ï¸</div>
            <div class="scenario-title">ä¿éšª eKYC</div>
            <div class="scenario-desc">éƒ¨åˆ†æ¸¬è©¦ (2 æ¨¡çµ„)</div>
          </button>
          <button @click="loadFintechScenario" class="scenario-card">
            <div class="scenario-icon">ğŸ’°</div>
            <div class="scenario-title">é‡‘èç§‘æŠ€ eKYC</div>
            <div class="scenario-desc">ä¸­ç­‰å¼·åº¦ (3 æ¨¡çµ„)</div>
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useRuntimeConfig } from '#app'

const router = useRouter()
const config = useRuntimeConfig()

// âœ… ä½¿ç”¨ç’°å¢ƒè®Šæ•¸
const apiBaseUrl = config.public.apiBaseUrl || 'http://localhost:7939'

// æ¸¬è©¦é…ç½®
const testConfig = ref({
  vectorIds: ['A1', 'A2', 'A3', 'A4', 'A5'],
  intensity: 'medium',
  targetUrl: 'https://bank-ekyc.example.com',
  generateReports: true
})

const availableVectors = ['A1', 'A2', 'A3', 'A4', 'A5']
const vectorNames: Record<string, string> = {
  'A1': 'StyleGAN3',
  'A2': 'Stable Diffusion',
  'A3': 'SimSwap',
  'A4': 'DeepFaceLab',
  'A5': 'DALLÂ·E'
}

const intensityLevels = [
  { value: 'low', label: 'ä½', icon: 'ğŸŸ¢' },
  { value: 'medium', label: 'ä¸­', icon: 'ğŸŸ¡' },
  { value: 'high', label: 'é«˜', icon: 'ğŸ”´' }
]

// åŸ·è¡Œç‹€æ…‹
const isExecuting = ref(false)
const executionProgress = ref(0)
const logs = ref<Array<{ timestamp: string; level: string; message: string }>>([])

// åŸ·è¡Œæ­¥é©Ÿ
const executionSteps = ref([
  { title: 'éšæ®µ 1: åŸ·è¡Œæ”»æ“Šæ¸¬è©¦', description: 'æ­£åœ¨åˆå§‹åŒ– AI æ”»æ“Šæ¨¡çµ„...', status: 'pending' },
  { title: 'éšæ®µ 2: OWASP ZAP æƒæ', description: 'åŸ·è¡Œ Web æ‡‰ç”¨ç¨‹å¼å®‰å…¨æƒæ...', status: 'pending' },
  { title: 'éšæ®µ 3: Grok AI åˆ†æ', description: 'ç”Ÿæˆæ»²é€æ¸¬è©¦å ±å‘Š...', status: 'pending' },
  { title: 'éšæ®µ 4: Grok AI ç´…éšŠå»ºè­°', description: 'ç”Ÿæˆæ”»æ“Šå»ºè­°...', status: 'pending' },
  { title: 'éšæ®µ 5: RAG çŸ¥è­˜æª¢ç´¢', description: 'æª¢ç´¢å®‰å…¨çŸ¥è­˜åº«...', status: 'pending' },
  { title: 'éšæ®µ 6: Gemini ä¼æ¥­å»ºè­°', description: 'ç”Ÿæˆä¼æ¥­æ”¹å–„å»ºè­°...', status: 'pending' },
  { title: 'éšæ®µ 7: Gemini é˜²ç¦¦ç­–ç•¥', description: 'ç”Ÿæˆé˜²ç¦¦ç­–ç•¥...', status: 'pending' },
  { title: 'éšæ®µ 8: ç”Ÿæˆå ±å‘Š', description: 'ç”Ÿæˆ PDF/Excel å ±å‘Š...', status: 'pending' }
])

// è¨ˆç®—å±¬æ€§
const selectedVectorsCount = computed(() => testConfig.value.vectorIds.length)
const hasSelectedVectors = computed(() => selectedVectorsCount.value > 0)

// æ–¹æ³•
async function executePentest() {
  if (!hasSelectedVectors.value) {
    addLog('warning', 'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ AI æ”»æ“Šæ¨¡çµ„')
    return
  }

  isExecuting.value = true
  executionProgress.value = 0
  logs.value = []
  
  // é‡ç½®æ­¥é©Ÿç‹€æ…‹
  executionSteps.value.forEach(step => step.status = 'pending')

  addLog('info', 'ğŸš€ é–‹å§‹åŸ·è¡Œå®Œæ•´æ»²é€æ¸¬è©¦...')
  addLog('info', `ç›®æ¨™: ${testConfig.value.targetUrl}`)
  addLog('info', `å¼·åº¦: ${testConfig.value.intensity.toUpperCase()}`)
  addLog('info', `æ¨¡çµ„: ${testConfig.value.vectorIds.join(', ')}`)

  try {
    // æ¨¡æ“¬é€²åº¦æ›´æ–°
    const progressInterval = setInterval(() => {
      if (executionProgress.value < 90) {
        executionProgress.value += 11.25 // 8å€‹éšæ®µ,æ¯éšæ®µ 11.25%
        const currentStep = Math.floor(executionProgress.value / 12.5)
        if (currentStep < executionSteps.value.length) {
          if (currentStep > 0) {
            executionSteps.value[currentStep - 1].status = 'completed'
          }
          executionSteps.value[currentStep].status = 'running'
        }
      }
    }, 6000) // æ¯6ç§’ä¸€å€‹éšæ®µ

    // âœ… å‘¼å«å¾Œç«¯ API (ä½¿ç”¨ç’°å¢ƒè®Šæ•¸)
    const response = await fetch(`${apiBaseUrl}/pentest/execute/full`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(testConfig.value)
    })

    clearInterval(progressInterval)
    executionProgress.value = 100

    // æ¨™è¨˜æ‰€æœ‰æ­¥é©Ÿå®Œæˆ
    executionSteps.value.forEach(step => step.status = 'completed')

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }

    const result = await response.json()

    addLog('success', `âœ… æ»²é€æ¸¬è©¦å®Œæˆï¼Session ID: ${result.sessionId}`)
    addLog('info', `æˆåŠŸç‡: ${result.executiveSummary.overallSuccessRate}`)
    addLog('warning', `é¢¨éšªç­‰ç´š: ${result.executiveSummary.riskLevel}`)

    if (result.downloads.pdfReport) {
      addLog('success', `ğŸ“„ PDF å ±å‘Š: ${result.downloads.pdfReport}`)
    }

    // å„²å­˜çµæœ
    localStorage.setItem('pentestResult', JSON.stringify(result))

    // 3ç§’å¾Œè·³è½‰
    addLog('success', 'âœ¨ 3ç§’å¾Œè·³è½‰åˆ°å ±å‘Šé é¢...')
    setTimeout(() => {
      router.push({
        path: '/reports',
        query: { sessionId: result.sessionId }
      })
    }, 3000)

  } catch (error: any) {
    addLog('error', `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`)
    console.error('åŸ·è¡ŒéŒ¯èª¤:', error)
  } finally {
    setTimeout(() => {
      isExecuting.value = false
    }, 3500)
  }
}

function addLog(level: string, message: string) {
  const timestamp = new Date().toLocaleTimeString('zh-TW')
  logs.value.push({ timestamp, level, message })
}

function clearLogs() {
  logs.value = []
  addLog('info', 'æ—¥èªŒå·²æ¸…ç©º')
}

// å¿«é€Ÿå ´æ™¯
function loadBankScenario() {
  testConfig.value = {
    vectorIds: ['A1', 'A2', 'A3', 'A4', 'A5'],
    intensity: 'high',
    targetUrl: 'https://bank-ekyc.example.com',
    generateReports: true
  }
  addLog('info', 'âœ… å·²è¼‰å…¥éŠ€è¡Œ eKYC æ¸¬è©¦å ´æ™¯')
}

function loadInsuranceScenario() {
  testConfig.value = {
    vectorIds: ['A3', 'A5'],
    intensity: 'high',
    targetUrl: 'https://insurance-ekyc.example.com',
    generateReports: true
  }
  addLog('info', 'âœ… å·²è¼‰å…¥ä¿éšª eKYC æ¸¬è©¦å ´æ™¯')
}

function loadFintechScenario() {
  testConfig.value = {
    vectorIds: ['A1', 'A3', 'A5'],
    intensity: 'medium',
    targetUrl: 'https://fintech-ekyc.example.com',
    generateReports: false
  }
  addLog('info', 'âœ… å·²è¼‰å…¥é‡‘èç§‘æŠ€ eKYC æ¸¬è©¦å ´æ™¯')
}
</script>

<style scoped>
@import '@/assets/css/pentest.css';

/* é¡å¤–æ¨£å¼ */
.config-form {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-label {
  color: var(--neon-green);
  font-weight: 600;
  font-size: 1rem;
}

.form-input {
  background: rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(57, 255, 20, 0.3);
  border-radius: 8px;
  padding: 0.75rem 1rem;
  color: var(--text-primary);
  font-size: 1rem;
  transition: all 0.3s;
}

.form-input:focus {
  outline: none;
  border-color: var(--neon-green);
  box-shadow: 0 0 15px rgba(57, 255, 20, 0.3);
}

/* å‘é‡å¡ç‰‡ç¶²æ ¼ */
.vector-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
}

.vector-card {
  background: rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(57, 255, 20, 0.3);
  border-radius: 10px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.vector-card:hover {
  border-color: var(--neon-cyan);
  transform: translateY(-2px);
}

.vector-card.vector-selected {
  border-color: var(--neon-green);
  background: rgba(57, 255, 20, 0.1);
}

.vector-checkbox {
  width: 18px;
  height: 18px;
}

.vector-content {
  display: flex;
  flex-direction: column;
}

.vector-id {
  color: var(--neon-green);
  font-weight: 700;
}

.vector-name {
  color: var(--text-secondary);
  font-size: 0.85rem;
}

/* å¼·åº¦é¸æ“‡å™¨ */
.intensity-selector {
  display: flex;
  gap: 1rem;
}

.intensity-option {
  flex: 1;
  background: rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  padding: 0.75rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}

.intensity-option:hover {
  border-color: var(--neon-cyan);
}

.intensity-option.intensity-selected {
  border-color: var(--neon-green);
  background: rgba(57, 255, 20, 0.1);
}

.intensity-radio {
  display: none;
}

/* å¿«é€Ÿå ´æ™¯ */
.quick-scenario-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.scenario-card {
  background: linear-gradient(135deg, rgba(10, 15, 28, 0.8), rgba(15, 25, 45, 0.6));
  border: 2px solid var(--neon-cyan);
  border-radius: 12px;
  padding: 1.5rem;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
}

.scenario-card:hover {
  border-color: var(--neon-green);
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(57, 255, 20, 0.3);
}

.scenario-icon {
  font-size: 3rem;
  margin-bottom: 0.5rem;
}

.scenario-title {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--neon-green);
  margin-bottom: 0.25rem;
}

.scenario-desc {
  color: var(--text-secondary);
  font-size: 0.9rem;
}
/* âœ… ä¿®æ­£æ—¥èªŒå€åŸŸ header æ¨£å¼ */
.log-section {
  margin-top: 2rem;
}

.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  gap: 1rem; /* âœ… åŠ å…¥é–“è· */
}

.section-title {
  color: var(--neon-green);
  font-size: 1.2rem;
  font-weight: 700;
  margin: 0; /* âœ… ç§»é™¤é è¨­ margin */
}

.clear-logs-btn {
  background: linear-gradient(135deg, rgba(255, 68, 68, 0.8), rgba(209, 112, 0, 0.6));
  border: 2px solid #FF4444;
  color: white;
  padding: 0.5rem 1.2rem;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  white-space: nowrap; /* âœ… é˜²æ­¢æ–‡å­—æ›è¡Œ */
}

.clear-logs-btn:hover {
  background: linear-gradient(135deg, rgba(255, 68, 68, 1), rgba(209, 112, 0, 0.8));
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 68, 68, 0.4);
}

.clear-logs-btn:active {
  transform: translateY(0);
}

/* æ—¥èªŒå®¹å™¨æ¨£å¼ */
.log-container {
  background: rgba(0, 0, 0, 0.8);
  border: 2px solid var(--neon-green);
  border-radius: 10px;
  padding: 1.5rem;
  font-family: 'Courier New', monospace;
  font-size: 0.9rem;
  height: 300px;
  overflow-y: auto;
  max-height: 400px;
}

/* æ—¥èªŒæ¢ç›®å‹•ç•« */
.log-entry {
  margin: 0.5rem 0;
  opacity: 0;
  animation: log-appear 0.5s ease-in-out forwards;
  padding: 0.3rem 0;
  line-height: 1.4;
}

@keyframes log-appear {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* æ—¥èªŒç­‰ç´šé¡è‰² */
.log-success {
  color: var(--neon-green);
}

.log-warning {
  color: #FFD700;
}

.log-error {
  color: #FF4444;
}

.log-info {
  color: var(--neon-cyan);
}

/* è‡ªè¨‚æ»¾å‹•æ¢ */
.log-container::-webkit-scrollbar {
  width: 8px;
}

.log-container::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.5);
  border-radius: 4px;
}

.log-container::-webkit-scrollbar-thumb {
  background: var(--neon-green);
  border-radius: 4px;
}

.log-container::-webkit-scrollbar-thumb:hover {
  background: var(--neon-cyan);
}

/* éŸ¿æ‡‰å¼èª¿æ•´ */
@media (max-width: 768px) {
  .log-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .clear-logs-btn {
    width: 100%;
  }

  .log-container {
    height: 250px;
    font-size: 0.85rem;
  }
}

/* CSS è®Šæ•¸ (å¦‚æœæ²’æœ‰åœ¨ pentest.css ä¸­å®šç¾©) */
:root {
  --neon-green: #39FF14;
  --neon-cyan: #00FFFF;
  --neon-pink: #FF10F0;
  --brand-orange: #D17000;
  --bg-dark: #000811;
  --bg-card: #0A0F1C;
  --text-primary: #FFFFFF;
  --text-secondary: rgba(255, 255, 255, 0.7);
}
</style>
